# 项目结构

```shell
├── index.html
├── main.js
├── api
│   └── ... # 抽取出API请求
├── components
│   ├── App.vue
│   └── ...
└── store
    ├── index.js          # 我们组装模块并导出 store 的地方
    ├── actions.js        # 根级别的 action
    ├── mutations.js      # 根级别的 mutation
    └── modules
        ├── cart.js       # 购物车模块
        └── products.js   # 产品模块
```

以上文件结构可以参考,不一定严格遵循,需要根据具体的场景来定义

# 组合式 API

通过`useStore`函数,可以在`setup`中访问到`store`; 和`this.store`是等效的.

```js
import { useStore } from "vuex";
export default {
  setup() {
    const store = useStore();
  },
  // 访问getters mutation类似computed的方式
};
```

[参考](https://github.com/vuejs/vuex/tree/main/examples/composition)

# 插件

VueX 的 store,接受 plugin 选项,会暴露出每次 mutation 的钩子函数.

```js
// 声明Plugin
const myPlugin = (store) => {
  // 当 store 初始化后调用
  store.subscribe((mutation, state) => {
    // 每次 mutation 之后调用
    // mutation 的格式为 { type, payload }
  });
};
// 使用Plugin
const store = createStore({
  // ...
  plugins: [myPlugin],
});
```

[参考](https://vuex.vuejs.org/zh/guide/plugins.html#%E5%9C%A8%E6%8F%92%E4%BB%B6%E5%86%85%E6%8F%90%E4%BA%A4-mutation)
[内置 Logger 插件](https://vuex.vuejs.org/zh/guide/plugins.html#%E5%86%85%E7%BD%AE-logger-%E6%8F%92%E4%BB%B6)

# 严格模式

在`严格模式`下,无论何时发生了状态变更,且不是由`mutation`函数引起的,将会抛出错误.
这能保证所有的状态变更都能被调试工具跟踪到.

在`生产模式`下, 不需要开启严格模式. 严格模式会深度监听和检测不合规的状态变更,这样会有大量的性能损耗.

# 表单处理

在`严格模式`下,使用`VueX`时,遇到和`v-model`配合使用时,会比较棘手.

```js
  <input v-model="obj.message">
```

假设这里的`obj`是计算中,返回的一个`VueX store`的对象.
在用户输入的时候, 会尝试修改`obj.message`.
在严格模式下,由于这个修改没有通过`mutations`来触发,这里会抛出一个错误.

此时,需要使用`VueX`的思维来处这个场景.

```html
<!-- 给input绑定一个value值,侦听input的change事件 -->
<input :value="message" @input="updateMessage" />
```

```js
// 侦听input的onchange事件,触发回调函数,从而驱动状态的变更.
computed: {
  ...mapState({
    message: state => state.obj.message
  })
},
methods: {
  updateMessage (e) {
    this.$store.commit('updateMessage', e.target.value)
  }
}
// ... VueX中定义的mutation
mutations: {
  updateMessage (state, message) {
    state.obj.message = message
  }
}
```

```js 双向绑定的计算属性,通过vuex修改
<input v-model="message">
// ...
computed: {
  message: {
    get () {
      return this.$store.state.obj.message
    },
    set (value) {
      this.$store.commit('updateMessage', value)
    }
  }
}
```

# 测试
[参考](https://vuex.vuejs.org/zh/guide/testing.html#%E6%B5%8B%E8%AF%95-mutation)

# 热重载
