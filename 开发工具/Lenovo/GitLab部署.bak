


## 本地安装 gitlab-ce
##### 本地下载并运行Docker镜像
```shell
# 需要查询3000端口是否被占用
lsof -i tcp:3000
# 如果300被占用，需要指定一个闲置的端口 「2000 - 60000之间都可以」

# 在dockerhub上搜索gitlab-ce: https://registry.hub.docker.com/
# 可以按需下载，这里下载的是 gitlab-ce-zh 汉化版
docker run -d -p 3000:80 twang2218/gitlab-ce-zh
# 可以通过 --name gitlab 来指定容器的name，我这里遗漏了
# eg. 容器内部:80 >>> 外部:3000
```
##### 启动本地 gitlab 服务
访问上面配置的本地3000端口 http://localhost:3000
- 首次访问时，可能会出现报错；
- 关闭再次进入，会进入到登陆页面；
- ※ 设置初始的账号密码：root/root123123
-------
## 本地安装 gitlab-runner
gitlab-runner 的安装启动形式有多种， 可以参考：[官网文档](https://docs.gitlab.com/runner/install/)

这里使用在docker环境中安装gitlab-runner

##### 本地下载并启动Runner镜像
我这里使用了docker卷创建
```shell
docker run -d --name gitlab-runner --restart always \
  --link mystifying_williams \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest
# mystifying_williams 是上一步安装 gitlab-ce 时的容器name
# 如果使用docker运行gitlab-ce和gitlab-runner， 就需要将它们进行连接，使其通信
# 这样设置等于告诉gitlab-runner容器，需要访问到哪个gitlab
# 官方的镜像太大了 :( 因为我们仅为了熟悉流程，可以找一些体积比较小的镜像
```
补充： 区分挂载的目录（本地/docker）
```shell
# 使用本地卷安装
docker run -d --name gitlab-runner --restart always \
  -v /Users/lingk/work/Lenovo/docker/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest
# 使用本地卷的时候，启动的时候可能没有权限； 我就遇到了这个问题，没有目录，无创建权限
# 指定的目录，需要在docker配置中暴露出来
```
```shell
# 使用docker卷安装
docker volume create gitlab-runner-config
# >>> gitlab-runner-config
docker run -d --name gitlab-runner --restart always \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v gitlab-runner-config:/etc/gitlab-runner \
    gitlab/gitlab-runner:latest
```
    执行完毕docker命令，在portainer中查看容器是否成功启动。
##### 配置 gitlab-runner
    让 gitlab-runner 工作，必须让 gitlab-runner 知道对应的 gitlab的安装地址，以及注册的 token ；

```shell
# 运行命令
docker exec -it gitlab-runner gitlab-runner register
```

```shell
# 注册一个runner
gitlab-runner register
# 依此输入 gitlab url、token、描述、tabs、选择执行的方式
# 参考： https://blog.csdn.net/afei__/article/details/82413724

gitlab-runner register \
  --non-interactive \
  --tls-ca-file=/etc/gitlab/ssl/gitlab.example.com.crt  \
  --url "http://172.16.41.29:3000/" \
  --registration-token "oWFrpicuPqwn_HfY_8NB" \
  --executor "shell" \
  --docker-image maven:latest \
  --description "testCI/CD-shell" \
  --tag-list "run" \
  --run-untagged \
  --locked="false"

```
